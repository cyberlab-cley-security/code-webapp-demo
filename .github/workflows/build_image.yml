name: Docker Build and Push to ECR - Optimized

on:
  workflow_dispatch:
    inputs:
      image_path:
        description: 'ECR image path <registry>/<repository> (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com/lab)'
        required: true
        type: string
        default: '<CHANGE ME>'
      aws_region:
        description: 'AWS region'
        required: true
        type: string
        default: 'us-east-1'
      target_repository:
        description: 'Target repository for deployment dispatch'
        required: false
        type: string
        default: 'cyberlab-cley-security/3-deploy-webapp-demo'

jobs:
  build-vuln-scan-and-push:
    runs-on: ubuntu-latest

    outputs:
      image_build: ${{ steps.image-info.outputs.FULL_IMAGE_BUILD }}
      vuln_count: ${{ steps.grype_scan.outputs.HIGH_CRIT_COUNT }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse ECR image path
        id: parse_ecr
        run: |
          IMAGE_PATH="${{ github.event.inputs.image_path }}"

          # Validation du format <registry>/<repository> (sans tag)
          if [[ ! "$IMAGE_PATH" =~ ^[0-9]+\.dkr\.ecr\.[a-z0-9-]+\.amazonaws\.com/.+$ ]]; then
            echo "‚ùå Format invalide: $IMAGE_PATH"
            echo "‚úÖ Format attendu: <registry>/<repository>"
            exit 1
          fi

          if [[ "$IMAGE_PATH" =~ :.+ ]]; then
            echo "‚ùå Le tag ne doit pas √™tre inclus dans l'image path"
            echo "‚úÖ Le tag sera g√©n√©r√© automatiquement: build-${{ github.run_number }}"
            exit 1
          fi

          ECR_REGISTRY=$(echo "$IMAGE_PATH" | cut -d'/' -f1)
          ECR_REPOSITORY=$(echo "$IMAGE_PATH" | cut -d'/' -f2-)
          IMAGE_TAG="build-${{ github.run_number }}"

          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "ECR_REPOSITORY=$ECR_REPOSITORY" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "ECR_URI=$IMAGE_PATH" >> $GITHUB_OUTPUT

          echo "‚úÖ ECR Registry: $ECR_REGISTRY"
          echo "‚úÖ ECR Repository: $ECR_REPOSITORY"
          echo "‚úÖ Image Tag: $IMAGE_TAG"
          echo "‚úÖ Base URI: $IMAGE_PATH"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry: ${{ steps.parse_ecr.outputs.ECR_REGISTRY }}

      - name: Ensure ECR repository exists
        run: |
          REPO_NAME=${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}
          AWS_REGION=${{ github.event.inputs.aws_region }}
          
          if ! aws ecr describe-repositories --repository-names $REPO_NAME --region $AWS_REGION >/dev/null 2>&1; then
            echo "üì¶ Repository does not exist. Creating..."
            aws ecr create-repository --repository-name $REPO_NAME --region $AWS_REGION
            echo "‚úÖ Repository created successfully"
          else
            echo "‚úÖ Repository already exists"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker

      - name: Install Grype
        run: |
          echo "üì• Installing Grype..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version

      - name: Security Scan with Grype (soft fail)
        id: grype_scan
        run: |
          IMAGE="${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan"
          grype "$IMAGE" -o json > grype-report.json 2>&1 || true
          grype "$IMAGE" -o table > grype-report.txt 2>&1 || true

          CRITICAL_COUNT=$(cat grype-report.json | jq '[.matches[].vulnerability.severity | select(. == "Critical")] | length' 2>/dev/null || echo 0)
          HIGH_COUNT=$(cat grype-report.json | jq '[.matches[].vulnerability.severity | select(. == "High")] | length' 2>/dev/null || echo 0)
          MEDIUM_COUNT=$(cat grype-report.json | jq '[.matches[].vulnerability.severity | select(. == "Medium")] | length' 2>/dev/null || echo 0)
          LOW_COUNT=$(cat grype-report.json | jq '[.matches[].vulnerability.severity | select(. == "Low")] | length' 2>/dev/null || echo 0)
          HIGH_CRIT_COUNT=$((CRITICAL_COUNT + HIGH_COUNT))

          echo "CRITICAL_COUNT=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "HIGH_COUNT=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "MEDIUM_COUNT=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "LOW_COUNT=$LOW_COUNT" >> $GITHUB_OUTPUT
          echo "HIGH_CRIT_COUNT=$HIGH_CRIT_COUNT" >> $GITHUB_OUTPUT

      - name: Tag and push to ECR
        run: |
          IMAGE_LOCAL="${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan"
          IMAGE_BUILD="${{ steps.parse_ecr.outputs.ECR_URI }}:${{ steps.parse_ecr.outputs.IMAGE_TAG }}"

          echo "üè∑Ô∏è  Tagging image..."
          docker tag "$IMAGE_LOCAL" "$IMAGE_BUILD"

          echo "üì§ Pushing to ECR..."
          docker push "$IMAGE_BUILD"

          echo "‚úÖ Image pushed successfully"
          echo "   üì¶ Build: $IMAGE_BUILD"

      - name: Upload Grype reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-scan-reports
          path: |
            grype-report.json
            grype-report.txt
          retention-days: 30

      - name: Image pushed successfully
        id: image-info
        run: |
          FULL_IMAGE_BUILD="${{ steps.parse_ecr.outputs.ECR_URI }}:${{ steps.parse_ecr.outputs.IMAGE_TAG }}"
          echo "FULL_IMAGE_BUILD=$FULL_IMAGE_BUILD" >> $GITHUB_OUTPUT
          echo "‚úÖ Docker image successfully built and pushed: $FULL_IMAGE_BUILD"

  dispatch-deploy:
    name: Dispatch Deployment
    runs-on: ubuntu-latest
    needs: build-vuln-scan-and-push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare and send deployment dispatch
        run: |
          IMAGE_URI="${{ needs.build-vuln-scan-and-push.outputs.image_build }}"
          TARGET_REPO="${{ github.event.inputs.target_repository }}"
          VULN_COUNT="${{ needs.build-vuln-scan-and-push.outputs.vuln_count }}"

          JSON_BODY=$(jq -n -c \
            --arg image_uri "$IMAGE_URI" \
            --arg vuln_count "$VULN_COUNT" \
            '{
              "event_type": "deploy-image",
              "client_payload": {
                "image_uri": $image_uri,
                "vulnerabilities": {
                  "high_critical_count": $vuln_count
                },
                "source_workflow": "${{ github.workflow }}",
                "source_run_id": "${{ github.run_id }}"
              }
            }'
          )

          echo "üöÄ Dispatching deployment to: $TARGET_REPO"
          echo "üì¶ Image: $IMAGE_URI"
          echo "‚ö†Ô∏è  Vulnerabilities (High/Critical): $VULN_COUNT"
          echo "$JSON_BODY" | gh api \
            --method POST \
            "repos/$TARGET_REPO/dispatches" \
            --input - && echo "‚úÖ Dispatch sent successfully" || echo "‚ùå Dispatch failed"
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

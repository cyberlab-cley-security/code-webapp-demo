name: Docker Build and Push to ECR - Single Input

on:
  workflow_dispatch:
    inputs:
      ecr_repository_uri:
        description: 'AWS ECR Repository URI (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com/lab)'
        required: true
        type: string
        default: '<CHANGE ME>' 
      image_tag:
        description: 'Docker image tag (e.g., latest, v1.0.0)'
        required: true
        type: string
        default: 'latest'
      aws_region:
        description: 'AWS region'
        required: true
        type: string
        default: 'us-east-1'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    # Les outputs sont définis à la fin via l'étape 'image-info'
    outputs:
      image_latest: ${{ steps.image-info.outputs.FULL_IMAGE_LATEST }}
      image_build: ${{ steps.image-info.outputs.FULL_IMAGE_BUILD }}
    
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Parse ECR URI to extract registry and repository name
      - name: Parse ECR URI
        id: parse_ecr
        run: |
          ECR_URI="${{ github.event.inputs.ecr_repository_uri }}"
          
          # Extract registry (host) and repository name
          ECR_REGISTRY=$(echo $ECR_URI | cut -d'/' -f1)
          ECR_REPOSITORY=$(echo $ECR_URI | cut -d'/' -f2-)
          
          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "ECR_REPOSITORY=$ECR_REPOSITORY" >> $GITHUB_OUTPUT
          
          echo "Parsed ECR URI:"
          echo "  Registry: $ECR_REGISTRY"
          echo "  Repository: $ECR_REPOSITORY"
      
      # Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}

      # Login to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry: ${{ steps.parse_ecr.outputs.ECR_REGISTRY }}

      # Ensure the ECR repository exists
      - name: Ensure ECR repository exists
        run: |
          REPO_NAME=${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}
          AWS_REGION=${{ github.event.inputs.aws_region }}

          if ! aws ecr describe-repositories --repository-names $REPO_NAME --region $AWS_REGION >/dev/null 2>&1; then
            echo "Repository does not exist. Creating..."
            aws ecr create-repository --repository-name $REPO_NAME --region $AWS_REGION
          else
            echo "Repository already exists."
          fi

      # Build local image (for scanning)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image locally for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: ${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan

      # Install Docker Scout 
      - name: Install Docker Scout
        run: |
          echo "Installing Docker Scout CLI..."
          curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | VERSION=v1.18.3 sh
          docker scout version || echo "⚠️ Docker Scout not installed, skipping scan"

      - name: Docker login for Scout
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Scan with Docker Scout 
      - name: Security control - Scan image with Docker Scout
        run: |
          IMAGE=${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan
          if command -v docker-scout >/dev/null 2>&1; then
            echo "Scanning image $IMAGE with Docker Scout..."
            docker scout cves $IMAGE > scout-results.txt 2>&1 || true

            echo "====== Docker Scout Summary ======"
            cat scout-results.txt
            echo "=================================="

            HIGH_CRITICAL=$(grep -E "HIGH|CRITICAL" scout-results.txt | wc -l)
            if [ "$HIGH_CRITICAL" -gt 0 ]; then
              echo "⚠️ ALERT: $HIGH_CRITICAL HIGH/CRITICAL vulnerabilities detected!"
            else
              echo "✅ No HIGH/CRITICAL vulnerabilities detected."
            fi
          else
            echo "⚠️ Docker Scout not found, skipping scan."
          fi

      - name: Upload Docker Scout results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-scout-results
          path: scout-results.txt
      
      # Build and push image to ECR
      - name: Build and push Docker image to ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Tags Docker, using two tags: the provided image_tag and the GitHub run number
          tags: | 
            ${{ github.event.inputs.ecr_repository_uri }}:${{ github.event.inputs.image_tag }}
            ${{ github.event.inputs.ecr_repository_uri }}:${{ github.run_number }}

      # Output full image paths + export as outputs
      - name: Image pushed successfully
        id: image-info
        run: |
          # Construction des chemins complets
          FULL_IMAGE_LATEST="${{ github.event.inputs.ecr_repository_uri }}:${{ github.event.inputs.image_tag }}"
          FULL_IMAGE_BUILD="${{ github.event.inputs.ecr_repository_uri }}:${{ github.run_number }}"

          echo "FULL_IMAGE_LATEST=$FULL_IMAGE_LATEST" >> $GITHUB_OUTPUT
          echo "FULL_IMAGE_BUILD=$FULL_IMAGE_BUILD" >> $GITHUB_OUTPUT

          echo "✔️ Docker image successfully built and pushed to ECR"
          echo ""
          echo "===== Full Image Paths ====="
          echo "Latest tag:   $FULL_IMAGE_LATEST"
          echo "Build tag:    $FULL_IMAGE_BUILD"
          echo "================================"

  dispatch-deploy:
    name: Dispatch Deployment
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Prepare JSON body with only the latest image URI
      - name: Prepare JSON for repository_dispatch
        id: prepare_json
        run: |
          IMAGE_URI="${{ needs.build-and-push.outputs.FULL_IMAGE_LATEST }}"

          JSON_BODY=$(jq -n -c \
            --arg image_uri "$IMAGE_URI" \
            '{
              "event_type": "deploy-image",
              "client_payload": {
                "image_uri": $image_uri
              }
            }'
          )

          echo "JSON_BODY=$JSON_BODY" >> $GITHUB_ENV
          echo "JSON body prepared for repository_dispatch:"
          echo "$JSON_BODY"

      # Send repository_dispatch to the target repo
      - name: Send repository_dispatch to deploy-webapp-demo
        run: |
          echo "Sending repository_dispatch with body:"
          echo "$JSON_BODY"
          echo "$JSON_BODY" | gh api \
            --method POST \
            repos/cyberlab-cley-security/deploy-webapp-demo/dispatches \
            --input -
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
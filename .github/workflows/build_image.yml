name: Docker Build and Push to ECR - Optimized

on:
  repository_dispatch:
    types:
      - trigger-webapp-build  # √©v√©nement attendu depuis le repo d√©clencheur

jobs:
  build-vuln-scan-and-push:
    runs-on: ubuntu-latest

    outputs:
      image_build: ${{ steps.image-info.outputs.FULL_IMAGE_BUILD }}
      vuln_count: ${{ steps.grype_scan.outputs.HIGH_CRIT_COUNT }}

    env:
      IMAGE_PATH: ${{ github.event.client_payload.ecr_url }}:${{ github.event.client_payload.image_tag }}
      AWS_REGION: ${{ github.event.client_payload.aws_region }}
      TARGET_REPO: ${{ github.event.client_payload.target_repository || 'cyberlab-cley-security/3-deploy-webapp-demo' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse ECR image path
        id: parse_ecr
        run: |
          IMAGE_PATH="${IMAGE_PATH}"

          # Validation du format <registry>/<repository>:tag
          if [[ ! "$IMAGE_PATH" =~ ^[0-9]+\.dkr\.ecr\.[a-z0-9-]+\.amazonaws\.com/.+:.+ ]]; then
            echo "‚ùå Format invalide: $IMAGE_PATH"
            exit 1
          fi

          ECR_REGISTRY=$(echo "$IMAGE_PATH" | cut -d'/' -f1)
          ECR_REPOSITORY=$(echo "$IMAGE_PATH" | cut -d'/' -f2- | cut -d':' -f1)
          IMAGE_TAG=$(echo "$IMAGE_PATH" | cut -d':' -f2)

          echo "ECR_REGISTRY=$ECR_REGISTRY" >> $GITHUB_OUTPUT
          echo "ECR_REPOSITORY=$ECR_REPOSITORY" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "ECR_URI=$ECR_REGISTRY/$ECR_REPOSITORY" >> $GITHUB_OUTPUT

          echo "‚úÖ ECR Registry: $ECR_REGISTRY"
          echo "‚úÖ ECR Repository: $ECR_REPOSITORY"
          echo "‚úÖ Image Tag: $IMAGE_TAG"
          echo "‚úÖ Base URI: $ECR_REGISTRY/$ECR_REPOSITORY"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry: ${{ steps.parse_ecr.outputs.ECR_REGISTRY }}

      - name: Ensure ECR repository exists
        run: |
          REPO_NAME=${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}
          AWS_REGION=${{ env.AWS_REGION }}
          
          if ! aws ecr describe-repositories --repository-names $REPO_NAME --region $AWS_REGION >/dev/null 2>&1; then
            echo "üì¶ Repository does not exist. Creating..."
            aws ecr create-repository --repository-name $REPO_NAME --region $AWS_REGION
            echo "‚úÖ Repository created successfully"
          else
            echo "‚úÖ Repository already exists"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image with cache
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker

      - name: Install Grype
        run: |
          echo "üì• Installing Grype..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype version

      - name: Security Scan with Grype (soft fail)
        id: grype_scan
        run: |
          IMAGE="${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan"
          grype "$IMAGE" -o json > grype-report.json 2>&1 || true
          grype "$IMAGE" -o table > grype-report.txt 2>&1 || true

          CRITICAL_COUNT=$(cat grype-report.json | jq '[.matches[].vulnerability.severity | select(. == "Critical")] | length' 2>/dev/null || echo 0)
          HIGH_COUNT=$(cat grype-report.json | jq '[.matches[].vulnerability.severity | select(. == "High")] | length' 2>/dev/null || echo 0)
          HIGH_CRIT_COUNT=$((CRITICAL_COUNT + HIGH_COUNT))

          echo "CRITICAL_COUNT=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "HIGH_COUNT=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "HIGH_CRIT_COUNT=$HIGH_CRIT_COUNT" >> $GITHUB_OUTPUT

      - name: Tag and push to ECR
        run: |
          IMAGE_LOCAL="${{ steps.parse_ecr.outputs.ECR_REPOSITORY }}:scan"
          IMAGE_BUILD="${{ steps.parse_ecr.outputs.ECR_URI }}:${{ steps.parse_ecr.outputs.IMAGE_TAG }}"
          docker tag "$IMAGE_LOCAL" "$IMAGE_BUILD"
          docker push "$IMAGE_BUILD"
          echo "‚úÖ Image pushed: $IMAGE_BUILD"

      - name: Upload Grype reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-scan-reports
          path: |
            grype-report.json
            grype-report.txt
          retention-days: 30

      - name: Image pushed successfully
        id: image-info
        run: |
          FULL_IMAGE_BUILD="${{ steps.parse_ecr.outputs.ECR_URI }}:${{ steps.parse_ecr.outputs.IMAGE_TAG }}"
          echo "FULL_IMAGE_BUILD=$FULL_IMAGE_BUILD" >> $GITHUB_OUTPUT
